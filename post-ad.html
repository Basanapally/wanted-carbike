<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Verified Ad | Wanted Car & Bike</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #ff4d4d; --dark: #121212; }
        body { background: var(--dark); color: white; font-family: 'Poppins', sans-serif; display: flex; justify-content: center; padding: 20px; }
        .form-box { background: #1e1e1e; padding: 30px; border-radius: 15px; width: 100%; max-width: 500px; border: 1px solid #333; }
        h2 { color: var(--primary); margin-top: 0; }
        label { font-size: 0.8rem; color: #aaa; display: block; margin-top: 12px; }
        input, select, textarea { 
            width: 100%; padding: 12px; margin-top: 5px; background: #2a2a2a; 
            border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; 
        }
        .upload-area { 
            border: 2px dashed #444; padding: 20px; text-align: center; 
            margin-top: 20px; border-radius: 10px; cursor: pointer; transition: 0.3s;
        }
        .upload-area:hover { border-color: var(--primary); }
        #statusTag { font-weight: 600; font-size: 0.85rem; margin-bottom: 10px; }
        button { 
            width: 100%; padding: 15px; background: var(--primary); color: white; 
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 25px; 
        }
        #progressOverlay { display: none; color: var(--primary); font-weight: bold; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>

<div class="form-box">
    <h2>Post Your Ad</h2>
    <div id="statusTag">Checking Account Type...</div>

    <form id="vehicleForm">
        <label>Category</label>
        <select id="vCategory" required>
            <option value="Car">Car</option>
            <option value="Bike">Bike</option>
        </select>

        <label>Brand</label>
        <input type="text" id="vBrand" placeholder="e.g. Toyota / Honda / Yamaha" required>

        <label>Model</label>
        <input type="text" id="vModel" placeholder="e.g. Civic / Corolla / R15" required>

        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label>Year</label>
                <input type="number" id="vYear" placeholder="2022" required>
            </div>
            <div style="flex: 1;">
                <label>KM Driven</label>
                <input type="number" id="vKM" placeholder="15000" required>
            </div>
        </div>

        <label>Price (RS)</label>
        <input type="number" id="vPrice" placeholder="Amount in RS" required>

        <label>Description</label>
        <textarea id="vDesc" rows="3" placeholder="Condition, service history, etc." required></textarea>

        <div class="upload-area" onclick="document.getElementById('vFiles').click()">
            <span id="uploadText">Click to Upload Local Photos</span>
            <input type="file" id="vFiles" multiple accept="image/*" style="display: none;">
        </div>
        <div id="fileCount" style="font-size: 0.8rem; margin-top: 5px; color: #888;">0 files selected</div>

        <div id="progressOverlay">Uploading to Cloud... <span id="percent">0%</span></div>
        <button type="submit" id="submitBtn">Post Verified Ad</button>
    </form>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDTl1dj4F-We96czvRrLEptlAWKM2n5ubk",
        authDomain: "wanted-carbike-62581.firebaseapp.com",
        projectId: "wanted-carbike-62581",
        storageBucket: "wanted-carbike-62581.firebasestorage.app",
        messagingSenderId: "537372034018",
        appId: "1:537372034018:web:ffb3999335b29407dbafbb"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // YOUR IMGBB KEY
    const IMGBB_API_KEY = "8253bcd4ad3481da5d45f23b9ad10355";

    let isPremium = false;
    let userRecord = null;

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "login.html"; return; }
        userRecord = user;
        const userSnap = await getDoc(doc(db, "users", user.uid));
        isPremium = userSnap.exists() && userSnap.data().isPremium;
        
        const tag = document.getElementById('statusTag');
        tag.innerText = isPremium ? "â­ PREMIUM: Unlimited Photos" : "STANDARD: Max 2 Photos";
        tag.style.color = isPremium ? "#ffd700" : "#888";
    });

    const fileInput = document.getElementById('vFiles');
    fileInput.onchange = () => {
        const limit = isPremium ? 50 : 2;
        if (fileInput.files.length > limit) {
            alert(`As a standard user, you can only select ${limit} photos.`);
            fileInput.value = "";
        }
        document.getElementById('fileCount').innerText = `${fileInput.files.length} files selected`;
    };

    document.getElementById('vehicleForm').onsubmit = async (e) => {
        e.preventDefault();
        const files = fileInput.files;
        if(files.length === 0) return alert("Please select at least one image.");

        const btn = document.getElementById('submitBtn');
        const progress = document.getElementById('progressOverlay');
        const percentText = document.getElementById('percent');
        
        btn.disabled = true;
        progress.style.display = "block";

        try {
            const urls = [];
            
            // Upload to ImgBB instead of Firebase Storage
            for (let i = 0; i < files.length; i++) {
                const formData = new FormData();
                formData.append("image", files[i]);

                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: "POST",
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    urls.push(result.data.url);
                    const percent = Math.round(((i + 1) / files.length) * 100);
                    percentText.innerText = percent + "%";
                } else {
                    throw new Error("ImgBB Upload Failed");
                }
            }

            // Save details to Firestore
            await addDoc(collection(db, "ads"), {
                category: document.getElementById('vCategory').value,
                brand: document.getElementById('vBrand').value,
                model: document.getElementById('vModel').value,
                year: document.getElementById('vYear').value,
                km: document.getElementById('vKM').value,
                price: document.getElementById('vPrice').value,
                desc: document.getElementById('vDesc').value,
                photos: urls,
                sellerId: userRecord.uid,
                sellerEmail: userRecord.email,
                postedAt: new Date()
            });

            alert("Verified Ad Posted Successfully!");
            window.location.href = "index.html";
        } catch (error) {
            alert("Upload failed: " + error.message);
            btn.disabled = false;
            progress.style.display = "none";
        }
    };
</script>

</body>
</html>